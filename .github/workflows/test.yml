name: Tests

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
  push:
    branches:
      - 'master'
      - 'develop'
      - 'release/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-scope:
    name: Check the scope
    runs-on: ubuntu-latest
    outputs:
      run-all: ${{
          endsWith(github.ref, '/master') ||
          endsWith(github.ref, '/develop') ||
          contains(github.ref, '/release/')
        }}
      build-handsontable-es-cjs: ${{ steps.path-filter.outputs.build-handsontable-es-cjs }}
      build-handsontable-umd: ${{ steps.path-filter.outputs.build-handsontable-umd }}
      test-handsontable-unit: ${{ steps.path-filter.outputs.test-handsontable-unit }}
      test-handsontable-types: ${{ steps.path-filter.outputs.test-handsontable-types }}
      test-handsontable-walkontable: ${{ steps.path-filter.outputs.test-handsontable-walkontable }}
      test-handsontable-e2e: ${{ steps.path-filter.outputs.test-handsontable-e2e }}
      test-handsontable-e2e-min: ${{ steps.path-filter.outputs.test-handsontable-e2e-min }}
      test-angular: ${{ steps.path-filter.outputs.test-angular }}
      test-react: ${{ steps.path-filter.outputs.test-react }}
      test-react-wrapper: ${{ steps.path-filter.outputs.test-react-wrapper }}
      test-vue: ${{ steps.path-filter.outputs.test-vue }}
      test-vue3: ${{ steps.path-filter.outputs.test-vue3 }}
      test-visual: ${{ steps.path-filter.outputs.test-visual }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1
        if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
      - uses: dorny/paths-filter@ebc4d7e9ebcb0b1eb21480bb8f43113e996ac77a # https://github.com/dorny/paths-filter/releases/tag/v3.0.1
        id: path-filter
        with:
          filters: |
            config-files: &config-files
              - './handsontable/.config/**'
              - './handsontable/package.json'
              - './package-lock.json'
              - './handsontable/hot.config.js'
              - './handsontable/babel.config.js'
              - './.github/workflows/test.yml'
              - './visual-tests/playwright.config.ts'
              - './visual-tests/playwright-cross-browser.config.ts'
            hot-definition-files: &hot-definition-files
              - './handsontable/base.d.ts'
              - './handsontable/handsontable.d.ts'
            hot-source-and-scripts: &hot-source-and-scripts
              - './handsontable/src/**'
              - './handsontable/scripts/**'
            hot-shared: &hot-shared
              - *config-files
              - *hot-source-and-scripts
            hot-e2e-test-shared: &hot-e2e-test-shared
              - './handsontable/test/e2e/**'
              - './handsontable/test/scripts/**'
            build-handsontable-umd:
              - *hot-shared
              - './handsontable/test/e2e/**'
              - './handsontable/test/scripts/**'
            build-handsontable-es-cjs:
              - *hot-shared
              - 'wrappers/**'
            test-handsontable-unit:
              - *hot-shared
              - './handsontable/test/unit/**'
            test-handsontable-types:
              - *hot-shared
              - *hot-definition-files
              - './handsontable/test/types/**'
            test-handsontable-walkontable:
              - './handsontable/.config/**'
              - './handsontable/test/scripts/**'
              - './handsontable/src/3rdparty/walkontable/**'
            test-handsontable-e2e:
              - *hot-shared
              - *hot-e2e-test-shared
            test-handsontable-e2e-min:
              - *hot-shared
              - *hot-e2e-test-shared
            test-angular:
              - *hot-shared
              - 'wrappers/angular/**'
            test-react:
              - *hot-shared
              - 'wrappers/react/**'
            test-react-wrapper:
              - *hot-shared
              - 'wrappers/react-wrapper/**'
            test-vue:
              - *hot-shared
              - 'wrappers/vue/**'
            test-vue3:
              - *hot-shared
              - 'wrappers/vue3/**'
            test-visual:
              - './examples/next/visual-tests/**'
              - './visual-tests/**'

  build-handsontable-umd:
    name: "[BUILD] Handsontable: UMD"
    runs-on: ubuntu-latest
    needs: [ check-scope ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.build-handsontable-umd == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Build
        run: |
          cd handsontable
          npm run build:umd
          npm run build:umd.min
          npm run build:languages
          npm run build:languages.min
      - run: tar -zcf dist.tar.gz ./handsontable/dist ./handsontable/styles

      - name: Upload the Handsontable UMD build artifact.
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # https://github.com/actions/upload-artifact/releases/tag/v4.3.1
        with:
          name: handsontable-build-umd
          path: dist.tar.gz

  build-handsontable-es-cjs:
    name: "[BUILD] Handsontable: ES + CJS"
    runs-on: ubuntu-latest
    needs: [ check-scope ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.build-handsontable-es-cjs == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Build
        run: |
          cd handsontable
          npm run build:es
          npm run build:commonjs
          npm run build:languages.es
          npm run build:classic-css
          npm run build:classic-css.min
          npm run postbuild
      - run: tar -zcf tmp.tar.gz ./handsontable/tmp

      - name: Upload the Handsontable ES + CJS build artifact.
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # https://github.com/actions/upload-artifact/releases/tag/v4.3.1
        with:
          name: handsontable-build-es-cjs
          path: tmp.tar.gz

  test-handsontable-unit:
    name: "[TEST] Handsontable: Unit"
    runs-on: ubuntu-latest
    needs: [ check-scope ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.test-handsontable-unit == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Test
        run: |
          cd handsontable
          npm run test:unit

  test-handsontable-types:
    name: "[TEST] Handsontable: Types"
    runs-on: ubuntu-latest
    needs: [ check-scope ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.test-handsontable-types == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Test
        run: |
          cd handsontable
          npm run test:types

  test-handsontable-walkontable:
    name: "[TEST] Walkontable"
    runs-on: ubuntu-latest
    needs: [ check-scope ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.test-handsontable-walkontable == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Test
        run: |
          cd handsontable
          npm run test:walkontable

  test-handsontable-e2e:
    name: "[TEST] Handsontable: UMD (theme: classic)"
    runs-on: ubuntu-latest
    needs: [ build-handsontable-umd ]
    if: |
      needs.check-scope.outputs.run-all == 'true' ||
      needs.check-scope.outputs.test-handsontable-e2e == 'true'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # https://github.com/actions/checkout/releases/tag/v4.1.1

      - name: Use Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # https://github.com/actions/setup-node/releases/tag/v4.0.2
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci --no-audit

      - name: Download the Handsontable build artifact
        uses: actions/download-artifact@87c55149d96e628cc2ef7e6fc2aab372015aec85 # https://github.com/actions/download-artifact/releases/tag/v4.1.3
        with:
          name: handsontable-build-umd
          path: ./
      - run: tar -zxf dist.tar.gz ./handsontable/dist && rm dist.tar.gz


